// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Hier beginnen die Datenmodelle

enum SystemRole {
  USER
  SYSADMIN
}

enum SeasonInterval {
  WEEKLY
  BI_WEEKLY
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
}

enum GroupInviteType {
  USER
  EMAIL
}

model User {
  id                     String     @id @default(cuid())
  email                  String     @unique
  password               String
  inAppName              String     @unique
  avatarImage            Bytes?
  avatarImageMime        String?
  systemRole             SystemRole @default(USER)
  emailVerified          DateTime?
  emailVerificationToken String?    @unique
  passwordResetTokenHash String?    @unique
  passwordResetTokenExpiresAt DateTime?
  createdAt              DateTime   @default(now())
  updatedAt              DateTime   @updatedAt

  ownedDecks     Deck[]
  groups         UsersOnGroups[]
  gamePlacements GamePlacement[]
  groupApplications GroupApplication[]
  seasonDismissals GroupSeasonDismissal[]
  sentGroupInvites GroupInvite[] @relation("GroupInviteInviter")
  receivedGroupInvites GroupInvite[] @relation("GroupInviteInvitedUser")
}

model Group {
  id           String @id @default(cuid())
  name         String
  format       String
  description  String?
  inviteCode   String   @unique @default(cuid())
  historyRetentionDays Int @default(30)
  groupImage   Bytes?
  groupImageMime String?
  activeSeasonName String?
  activeSeasonEndsAt DateTime?
  activeSeasonStartedAt DateTime?
  nextSeasonName String?
  nextSeasonStartsAt DateTime?
  nextSeasonEndsAt DateTime?
  nextSeasonIsSuccessive Boolean @default(false)
  nextSeasonInterval SeasonInterval?
  nextSeasonIntermissionDays Int @default(0)
  seasonPauseDays Int @default(0)
  seasonPauseUntil DateTime?
  lastSeasonId String? @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  members      UsersOnGroups[]
  decks        Deck[]
  games        Game[]
  events       GroupEvent[]
  applications GroupApplication[]
  invites      GroupInvite[]
  seasons      GroupSeason[]
  lastSeason   GroupSeason? @relation("GroupLastSeason", fields: [lastSeasonId], references: [id])
}

model UsersOnGroups {
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  group     Group    @relation(fields: [groupId], references: [id])
  groupId   String
  role      String   // "ADMIN" or "MEMBER"
  assignedAt DateTime @default(now())

  @@id([userId, groupId])
}

model Deck {
  id                String  @id @default(cuid())
  name              String
  colors            String  // z.B. "WUBRG", "RG", "B"
  type              String? // z.B. "Aggro", "Control"
  isActive          Boolean @default(true)
  performanceRating Float   @default(0)
  gamesPlayed       Int     @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Archidekt Integration
  archidektId       String?   // Archidekt Deck ID (z.B. "12784239")
  archidektImageUrl String?   // Featured Image URL von Archidekt
  archidektLastSync DateTime? // Letzter Sync mit Archidekt API

  owner    User   @relation(fields: [ownerId], references: [id])
  ownerId  String
  group    Group  @relation(fields: [groupId], references: [id])
  groupId  String

  placements GamePlacement[]
  seasonSnapshots GroupSeasonDeck[]

  @@unique([name, groupId]) // Deckname muss pro Gruppe unique sein
}

model Game {
  id        String   @id @default(cuid())
  playedAt  DateTime @default(now())
  playerCount Int
  createdAt DateTime @default(now())

  group   Group  @relation(fields: [groupId], references: [id])
  groupId String

  placements GamePlacement[]
}

model GamePlacement {
  id         String   @id @default(cuid())
  rank       Int
  points     Float
  playerName String? // Für Gast-Spieler
  deletedDeckName String? // Name des gelöschten Decks (für Historie)

  game   Game   @relation(fields: [gameId], references: [id])
  gameId String
  deck   Deck?  @relation(fields: [deckId], references: [id], onDelete: SetNull)
  deckId String?
  user   User?  @relation(fields: [userId], references: [id]) // Der tatsächliche Spieler (kann null sein für Gäste)
  userId String?
}

model GroupEvent {
  id        String   @id @default(cuid())
  type      String   // DECK_CREATED, DECK_DELETED, DECK_DEACTIVATED, DECK_REACTIVATED, MEMBER_JOINED, MEMBER_LEFT, MEMBER_REMOVED, GAME_RECORDED, GAME_UNDONE
  message   String   // Kurze Beschreibung des Events
  createdAt DateTime @default(now())

  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId String
}

model GroupApplication {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  user   User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  group  Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId String

  @@unique([userId, groupId])
}

model GroupInvite {
  id            String          @id @default(cuid())
  createdAt     DateTime        @default(now())
  type          GroupInviteType
  invitedEmail  String

  group         Group           @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId       String

  inviter       User            @relation("GroupInviteInviter", fields: [inviterUserId], references: [id], onDelete: Cascade)
  inviterUserId String

  invitedUser   User?           @relation("GroupInviteInvitedUser", fields: [invitedUserId], references: [id], onDelete: Cascade)
  invitedUserId String?

  @@unique([groupId, invitedUserId])
  @@unique([groupId, invitedEmail])
  @@index([groupId])
  @@index([inviterUserId])
  @@index([invitedUserId])
  @@index([invitedEmail])
}

model GroupSeason {
  id        String   @id @default(cuid())
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId   String
  name      String?
  startedAt DateTime
  endedAt   DateTime
  createdAt DateTime @default(now())

  decks     GroupSeasonDeck[]
  dismissals GroupSeasonDismissal[]
  lastSeasonOfGroup Group? @relation("GroupLastSeason")

  @@index([groupId, endedAt])
}

model GroupSeasonDeck {
  id        String   @id @default(cuid())
  season    GroupSeason @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  seasonId  String
  deck      Deck? @relation(fields: [deckId], references: [id], onDelete: SetNull)
  deckId    String?
  deckName  String
  colors    String
  ownerName String
  performanceRating Float
  gamesPlayed Int
  position  Int
}

model GroupSeasonDismissal {
  id        String   @id @default(cuid())
  season    GroupSeason @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  seasonId  String
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  dismissedAt DateTime @default(now())

  @@unique([seasonId, userId])
}
