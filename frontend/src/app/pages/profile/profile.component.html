<div class="modal-overlay" (click)="closeModal()">
  <div class="modal card modal--profile" (click)="$event.stopPropagation()">
    <div class="modal__header">
      <h2>Profile Settings</h2>
      <button class="modal__close" (click)="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    @if (loading()) {
      <div class="loading-container">
        <div class="spinner"></div>
        <p>Loading profile...</p>
      </div>
    } @else if (error()) {
      <div class="alert alert--danger">
        <i class="fas fa-exclamation-circle"></i>
        {{ error() }}
      </div>
    } @else if (profile()) {
      @if (editSuccess()) {
        <div class="alert alert--success">
          <i class="fas fa-check-circle"></i>
          Profile updated successfully!
        </div>
      }

      @if (avatarSuccess()) {
        <div class="alert alert--success">
          <i class="fas fa-check-circle"></i>
          Avatar uploaded successfully!
        </div>
      }

      <div class="profile-header">
        <div class="profile-avatar-block">
          <div class="profile-avatar">
            @if (avatarPreview() || profile()!.avatarUrl) {
              <img
                [src]="avatarPreview() || profile()!.avatarUrl || ''"
                alt="Profile avatar"
                class="profile-avatar__image"
              />
            } @else {
              <i class="fas fa-user"></i>
            }
          </div>

          @if (avatarError()) {
            <div class="alert alert--danger avatar-alert">{{ avatarError() }}</div>
          }

          <div class="avatar-actions">
            <input
              type="file"
              accept="image/png,image/jpeg,image/webp"
              (change)="onAvatarSelected($event)"
              [disabled]="avatarUploading()"
            />
            <button
              type="button"
              class="btn btn--outline btn--block"
              (click)="uploadAvatar()"
              [disabled]="avatarUploading()"
            >
              @if (avatarUploading()) { Uploading... } @else { Upload Avatar }
            </button>
          </div>
        </div>

        <div class="profile-info">
          @if (editMode()) {
            <div class="edit-form">
              @if (editError()) {
                <div class="alert alert--danger">{{ editError() }}</div>
              }
              <div class="form-group">
                <label for="editName">Display Name</label>
                <input
                  type="text"
                  id="editName"
                  class="form-control"
                  [(ngModel)]="editName"
                  [disabled]="editLoading()"
                  placeholder="Your display name"
                />
              </div>
              <div class="edit-actions">
                <button class="btn btn--outline" (click)="cancelEditing()" [disabled]="editLoading()">
                  Cancel
                </button>
                <button class="btn btn--primary" (click)="saveProfile()" [disabled]="editLoading()">
                  @if (editLoading()) { Saving... } @else { Save }
                </button>
              </div>
            </div>
          } @else {
            <div class="profile-name-row">
              <h3>{{ profile()!.inAppName }}</h3>
              <button class="btn-icon" type="button" (click)="startEditing()" title="Edit display name">
                <i class="fas fa-edit"></i>
              </button>
            </div>
          }
        </div>
      </div>

      <div class="profile-details">
        <div class="detail-row">
          <span class="detail-label"><i class="fas fa-envelope"></i> Email</span>
          <span class="detail-value detail-value--email">{{ profile()!.email }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label"><i class="fas fa-check-circle"></i> Email Verified</span>
          <span class="detail-value" [class.verified]="profile()!.emailVerified">
            @if (profile()!.emailVerified) {
              <i class="fas fa-check"></i> {{ formatDate(profile()!.emailVerified) }}
            } @else {
              <i class="fas fa-times"></i> Not verified
            }
          </span>
        </div>
        <div class="detail-row">
          <span class="detail-label"><i class="fas fa-calendar"></i> Member Since</span>
          <span class="detail-value">{{ formatDate(profile()!.createdAt) }}</span>
        </div>
      </div>

      @if (!profile()!.emailVerified) {
        <div class="verification-help">
          <p class="text-muted">
            You can request a new verification email once your previous verification link has expired.
          </p>
          <button
            type="button"
            class="btn btn--outline"
            (click)="resendVerificationEmail()"
            [disabled]="resendVerificationLoading() || deleteLoading()"
          >
            @if (resendVerificationLoading()) { Sending... } @else { Resend verification email }
          </button>

          @if (resendVerificationSuccess()) {
            <div class="alert alert--success">{{ resendVerificationSuccess() }}</div>
          }
          @if (resendVerificationError()) {
            <div class="alert alert--danger">{{ resendVerificationError() }}</div>
          }
        </div>
      }

      <div class="modal__actions modal__actions--split">
        <div class="account-actions">
          <button type="button" class="btn btn--outline" (click)="logout()" [disabled]="deleteLoading()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
          <button type="button" class="btn btn--danger" (click)="openDeleteConfirm()" [disabled]="deleteLoading()">
            <i class="fas fa-trash"></i> Delete this Account
          </button>
        </div>
        <div class="modal__actions">
          <button type="button" class="btn btn--primary" (click)="closeModal()" [disabled]="deleteLoading()">
            Done
          </button>
        </div>
      </div>
    }
  </div>
</div>

@if (deleteConfirmOpen()) {
  <div class="modal-overlay modal-overlay--nested" (click)="closeDeleteConfirm()">
    <div class="modal card modal--confirm-delete" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <h3>Do you really want to delete your account?</h3>
        <button class="modal__close" (click)="closeDeleteConfirm()" [disabled]="deleteLoading()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <p class="confirm-warning">
        With confirmation, your account will be permanently deleted and removed from all groups.
      </p>

      @if (deleteError()) {
        <div class="alert alert--danger">{{ deleteError() }}</div>
      }

      <div class="modal__actions">
        <button type="button" class="btn btn--outline" (click)="closeDeleteConfirm()" [disabled]="deleteLoading()">
          Cancel
        </button>
        <button type="button" class="btn btn--danger btn--confirm-action" (click)="confirmDeleteAccount()" [disabled]="deleteLoading()">
          @if (deleteLoading()) { Deleting... } @else { Confirm Delete }
        </button>
      </div>
    </div>
  </div>
}
