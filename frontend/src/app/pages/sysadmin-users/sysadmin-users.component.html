<div class="sysadmin-page">
  <header class="header">
    <div class="header__content container">
      <div class="header__left">
        <button class="btn btn--outline" (click)="goBack()">
          <i class="fas fa-arrow-left"></i>
        </button>
        <h1><i class="fas fa-shield-alt"></i> Sysadmin User Management</h1>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="search-bar card">
      <input
        type="text"
        class="form-control"
        [(ngModel)]="searchQuery"
        placeholder="Search groups"
        (keyup.enter)="search()"
      />
      <button class="btn btn--primary" (click)="search()">Search</button>
    </div>

    @if (loading()) {
      <div class="loading-container">
        <div class="spinner"></div>
        <p>Loading groups...</p>
      </div>
    } @else if (error()) {
      <div class="alert alert--danger">
        <i class="fas fa-exclamation-circle"></i>
        {{ error() }}
        <button class="btn btn--outline" (click)="loadGroups()">Retry</button>
      </div>
    } @else {
      @if (groups().length === 0) {
        <div class="empty-state card">
          <h2>No groups found</h2>
          <p>Try another search.</p>
        </div>
      } @else {
        <div class="groups-list">
          @for (group of groups(); track group.id) {
            <div class="group-card card">
              <div class="group-card__header">
                <div>
                  <h2>{{ group.name }}</h2>
                  <span class="group-card__format">{{ group.format }}</span>
                </div>
                <button class="btn btn--danger" (click)="deleteGroup(group)">Delete group</button>
              </div>

              @if (group.description) {
                <p class="group-card__description">{{ group.description }}</p>
              }

              <div class="members-table">
                <div class="members-table__header">
                  <span>Name</span>
                  <span>Email</span>
                  <span>Status</span>
                  <span>Actions</span>
                </div>
                @for (member of group.members; track member.userId) {
                  <div class="members-table__row">
                    <span>{{ member.user.inAppName }}</span>
                    <span>{{ member.user.email }}</span>
                    <span>{{ member.role }}</span>
                    <div class="members-table__actions">
                      <button class="btn btn--outline" (click)="openRenameModal(member)">Rename</button>
                      @if (member.role === 'ADMIN') {
                        <button class="btn btn--outline" (click)="demoteMember(group.id, member)">Demote</button>
                      } @else {
                        <button class="btn btn--outline" (click)="promoteMember(group.id, member)">Promote</button>
                      }
                      <button class="btn btn--outline btn--danger" (click)="removeMember(group.id, member)">
                        Remove
                      </button>
                      <button class="btn btn--danger" (click)="deleteUser(member)">Delete account</button>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>

        @if (totalPages() > 1) {
          <div class="pagination">
            <button class="btn btn--outline" (click)="setPage(page() - 1)" [disabled]="page() === 1">
              Prev
            </button>
            <span class="pagination__info">Page {{ page() }} of {{ totalPages() }}</span>
            <button class="btn btn--outline" (click)="setPage(page() + 1)" [disabled]="page() === totalPages()">
              Next
            </button>
          </div>
        }
      }
    }
  </main>
</div>

<!-- Rename Modal -->
@if (showRenameModal()) {
  <div class="modal-overlay" (click)="closeRenameModal()">
    <div class="modal card" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <h2>Rename user</h2>
        <button class="modal__close" (click)="closeRenameModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      @if (renameError()) {
        <div class="alert alert--danger">{{ renameError() }}</div>
      }

      <div class="form-group">
        <label>New name</label>
        <input
          type="text"
          class="form-control"
          [(ngModel)]="renameValue"
          [disabled]="renameLoading()"
        />
      </div>

      <div class="modal__actions">
        <button class="btn btn--outline" (click)="closeRenameModal()" [disabled]="renameLoading()">Cancel</button>
        <button class="btn btn--primary" (click)="confirmRename()" [disabled]="renameLoading()">
          @if (renameLoading()) { Saving... } @else { Save }
        </button>
      </div>
    </div>
  </div>
}

<!-- Confirm Modal -->
@if (showConfirmModal()) {
  <div class="modal-overlay" (click)="closeConfirmModal()">
    <div class="modal modal--confirm card" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <h2>{{ confirmTitle }}</h2>
        <button class="modal__close" (click)="closeConfirmModal()" [disabled]="confirmLoading()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <p class="modal__message">{{ confirmMessage }}</p>
      <div class="modal__actions">
        <button class="btn btn--outline" (click)="closeConfirmModal()" [disabled]="confirmLoading()">Cancel</button>
        <button class="btn btn--danger" (click)="executeConfirmAction()" [disabled]="confirmLoading()">
          @if (confirmLoading()) { Processing... } @else { Confirm }
        </button>
      </div>
    </div>
  </div>
}
