<div class="group-detail-page" [style.--viewport-width.px]="viewportWidth()" [style.--viewport-height.px]="viewportHeight()">
  @if (loading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading group...</p>
    </div>
  } @else if (error()) {
    <div class="container">
      <div class="alert alert--danger">
        <i class="fas fa-exclamation-circle"></i>
        {{ error() }}
      </div>
      <button class="btn btn--outline" (click)="goBack()">
        <i class="fas fa-arrow-left"></i> Back to Groups
      </button>
    </div>
  } @else if (group()) {
    <app-group-header
      [group]="group()!"
      [isAdmin]="isAdmin()"
      [defaultGroupImage]="defaultGroupImage"
      (back)="goBack()"
      (editGroup)="openEditGroupModal()"
      (copyInviteCode)="copyInviteCode()"
      (regenerateInviteCode)="regenerateInviteCode()"
      (openMemberSettings)="openMemberSettingsModal()"
      (openSeasonSettings)="openSeasonSettingsModal()"
      (openGroupSettings)="openGroupSettingsModal()"
    />

    @if (group()!.winnersBanner) {
      <div class="container">
        <app-group-winners-banner
          [banner]="group()!.winnersBanner!"
          [defaultDeckImage]="defaultDeckImage"
          (dismiss)="dismissWinnersBanner()"
        />
      </div>
    }

    @if (group()!.decks.length === 0) {
      <div class="container">
        <section class="card group-onboarding-hint">
          <h2><i class="fas fa-info-circle"></i> Group setup hint</h2>
          <p>
            No decks are available yet. Add at least two active decks to start or record games.
          </p>
        </section>
      </div>
    }

    <main class="container main-content">
      <div class="content-grid">
        <!-- Left Column: Ranking & History -->
        <div class="left-column">
          <app-group-ranking-card
            class="ranking-card"
            [activeSeasonEndsAt]="group()!.activeSeasonEndsAt"
            [activeSeasonName]="group()!.activeSeasonName"
            [seasonCountdown]="seasonCountdown()"
            [seasonCountdownState]="seasonCountdownState()"
            [rankingMode]="rankingMode()"
            [snapshotAvailable]="snapshotAvailable()"
            [ranking]="ranking()"
            [paginatedRanking]="paginatedRanking()"
            [rankingPage]="rankingPage()"
            [rankingTotalPages]="rankingTotalPages()"
            [showTrends]="showRankingTrends()"
            [defaultDeckImage]="defaultDeckImage"
            [getColorGradient]="getColorGradient.bind(this)"
            [getDeckImageUrl]="getDeckImageUrl.bind(this)"
            [getManaSymbols]="getManaSymbols.bind(this)"
            [getArchidektUrl]="getArchidektUrl.bind(this)"
            [formatDate]="formatDate.bind(this)"
            (rankingModeToggle)="toggleRankingMode()"
            (rankingPageChange)="setRankingPage($event)"
          />

          <app-group-history-card
            class="history-card"
            [historyFilter]="historyFilter()"
            [filteredHistoryLength]="filteredHistory().length"
            [paginatedHistory]="paginatedHistory()"
            [historyTotalPages]="historyTotalPages()"
            [historyPage]="historyPage()"
            [isAdmin]="isAdmin()"
            [isEmailVerified]="isEmailVerified()"
            [gamesLength]="games().length"
            [formatDate]="formatDate.bind(this)"
            [getManaSymbols]="getManaSymbols.bind(this)"
            (historyFilterChange)="setHistoryFilter($event)"
            (historyPageChange)="setHistoryPage($event)"
            (undoLast)="undoLastGame()"
          />
        </div>

        <!-- Right Column: Actions & Decks -->
        <div class="right-column">
          <!-- Actions -->
          @if (showActionsCard()) {
            <app-group-actions-card
              class="actions-card"
              [isEmailVerified]="isEmailVerified()"
              [isAdmin]="isAdmin()"
              [isSeasonPaused]="isSeasonPaused()"
              [seasonPauseUntil]="group()!.seasonPauseUntil"
              [isSmartphoneViewport]="isSmartphoneViewport()"
              [canStartPlayGame]="canStartPlayGame()"
              [canRecordGame]="canRecordGame()"
              [playGameDisabledReason]="playGameDisabledReason()"
              [recordGameDisabledReason]="recordGameDisabledReason()"
              [formatDate]="formatDate.bind(this)"
              (playGame)="openPlayGame()"
              (recordGame)="openGameModal()"
            />
          }

          <!-- Statistics -->
          <app-group-stats-card
            class="stats-card"
            [statsCollapsed]="statsCollapsed()"
            [statsMessage]="statsMessage()"
            [statsCategory]="statsCategory()"
            [statsOption]="statsOption()"
            [statsDeckId]="statsDeckId()"
            [statsDeckSearch]="statsDeckSearch()"
            [statsDeckDropdownOpen]="statsDeckDropdownOpen()"
            [filteredStatsDecks]="filteredStatsDecks()"
            [getDeckNameById]="getDeckNameById.bind(this)"
            [getManaSymbols]="getManaSymbols.bind(this)"
            (toggleCollapsed)="toggleStatsCollapsed()"
            (statsCategoryChange)="setStatsCategory($event)"
            (statsOptionChange)="setStatsOption($event)"
            (statsDeckSearchChange)="onStatsDeckSearchChange($event)"
            (openStatsDeckDropdown)="openStatsDeckDropdown()"
            (closeStatsDeckDropdownDelayed)="closeStatsDeckDropdownDelayed()"
            (selectStatsDeck)="selectStatsDeck($event)"
            (clearStatsDeckSelection)="clearStatsDeckSelection()"
            (chartReady)="onStatsChartReady($event)"
          />

          <!-- Decks List -->
          <app-group-decks-card
            class="decks-card"
            [decksCollapsed]="decksCollapsed()"
            [isEmailVerified]="isEmailVerified()"
            [decksLength]="group()!.decks.length"
            [decksSearchTerm]="decksSearchTerm()"
            [deckSortMode]="deckSortMode()"
            [filteredDecks]="filteredDecks()"
            [paginatedDecks]="paginatedDecks()"
            [decksPage]="decksPage()"
            [decksTotalPages]="decksTotalPages()"
            [defaultDeckImage]="defaultDeckImage"
            [getColorGradient]="getColorGradient.bind(this)"
            [getManaSymbols]="getManaSymbols.bind(this)"
            [getDeckTypeLabel]="getDeckTypeLabel.bind(this)"
            [canEditDeck]="canEditDeck.bind(this)"
            (toggleCollapsed)="toggleDecksCollapsed()"
            (addDeck)="openDeckModal()"
            (editDeck)="openEditDeckModal($event)"
            (decksSearchChange)="setDecksSearch($event)"
            (deckSortModeChange)="setDeckSortMode($event)"
            (decksPageChange)="setDecksPage($event)"
          />

          <!-- Members -->
          <app-group-members-card
            class="members-card"
            [membersCollapsed]="membersCollapsed()"
            [members]="group()!.members"
            [isAdmin]="isAdmin()"
            (toggleCollapsed)="toggleMembersCollapsed()"
            (inviteUser)="openInviteUserModal()"
          />
        </div>
      </div>
    </main>
    @if (showScrollTop()) {
      <button class="scroll-top-fab" (click)="scrollToTop()" title="Back to top" aria-label="Back to top">
        <i class="fas fa-arrow-up"></i>
      </button>
    }
  }
</div>

<!-- Add Deck Modal -->
@if (showDeckModal()) {
  <app-group-deck-create-modal
    [deckError]="deckError()"
    [deckLoading]="deckLoading()"
    [deckName]="deckName"
    [deckColors]="deckColors"
    [deckType]="deckType"
    [deckArchidektUrl]="deckArchidektUrl"
    [colorDropdownOpen]="colorDropdownOpen"
    [colorOptions]="colorOptions"
    [typeOptions]="typeOptions"
    [getManaSymbols]="getManaSymbols.bind(this)"
    (deckNameChange)="deckName = $event"
    (deckColorsChange)="deckColors = $event"
    (deckTypeChange)="deckType = $event"
    (deckArchidektUrlChange)="deckArchidektUrl = $event"
    (openColorDropdown)="openColorDropdown()"
    (closeColorDropdown)="closeColorDropdown()"
    (selectColor)="selectColor($event)"
    (close)="closeDeckModal()"
    (submit)="createDeck()"
  />
}

<!-- Record Game Modal -->
@if (showGameModal()) {
  <app-group-record-game-modal
    [gamePlacements]="gamePlacements"
    [gameLoading]="gameLoading()"
    [gameError]="gameError()"
    [prefilledGame]="prefilledGame()"
      [isSeasonPaused]="isSeasonPaused()"
      [seasonPauseUntil]="group()!.seasonPauseUntil"
      [formatDate]="formatDate.bind(this)"
      [deckDropdownOpen]="deckDropdownOpen"
    [memberNames]="memberNames()"
    [allDecksSelected]="allDecksSelected()"
    [getAvailableRanksForSlot]="getAvailableRanksForSlot.bind(this)"
    [getDeckNameById]="getDeckNameById.bind(this)"
    [getFilteredDecksForSlot]="getFilteredDecksForSlot.bind(this)"
    [getManaSymbols]="getManaSymbols.bind(this)"
    (close)="closeGameModal()"
    (submit)="createGame()"
    (addPlayer)="addPlayer()"
    (removePlayer)="removePlayer($event)"
    (deckSearchInput)="onDeckSearchInput($event.index, $event.event)"
    (openDeckDropdown)="openDeckDropdown($event)"
    (closeDeckDropdownDelayed)="closeDeckDropdownDelayed($event)"
    (selectDeck)="selectDeck($event.index, $event.deckId, $event.deckName)"
    (clearDeckSelection)="clearDeckSelection($event)"
    (closeAllDeckDropdowns)="closeAllDeckDropdowns()"
  />
}

<!-- Edit Deck Modal -->
@if (showEditDeckModal()) {
  <app-group-deck-edit-modal
    [assignOwnerOptions]="deckOwnerOptions()"
    [editDeckError]="editDeckError()"
    [editDeckLoading]="editDeckLoading()"
    [editDeckName]="editDeckName"
    [editDeckColors]="editDeckColors"
    [editDeckType]="editDeckType"
    [editDeckOwnerId]="editDeckOwnerId"
    [currentDeckOwnerId]="editingDeck?.owner?.id || ''"
    [editDeckIsActive]="editDeckIsActive"
    [editDeckArchidektUrl]="editDeckArchidektUrl"
    [editColorDropdownOpen]="editColorDropdownOpen"
    [colorOptions]="colorOptions"
    [typeOptions]="typeOptions"
    [getManaSymbols]="getManaSymbols.bind(this)"
    [hasArchidektId]="!!editingDeck?.archidektId"
    (editDeckNameChange)="editDeckName = $event"
    (editDeckColorsChange)="editDeckColors = $event"
    (editDeckTypeChange)="editDeckType = $event"
    (editDeckOwnerIdChange)="editDeckOwnerId = $event"
    (editDeckIsActiveChange)="editDeckIsActive = $event"
    (editDeckArchidektUrlChange)="editDeckArchidektUrl = $event"
    (assignOwner)="assignDeckOwner()"
    (openEditColorDropdown)="openEditColorDropdown()"
    (closeEditColorDropdown)="closeEditColorDropdown()"
    (selectEditColor)="selectEditColor($event)"
    (refreshArchidekt)="refreshArchidekt()"
    (requestDeleteDeck)="requestDeleteDeck()"
    (close)="closeEditDeckModal()"
    (submit)="updateDeck()"
  />
}

  <!-- Edit Group Modal -->
  @if (showEditGroupModal()) {
    <div class="modal-overlay">
      <div class="modal card" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <h2>Edit Group</h2>
        <button class="modal__close" (click)="closeEditGroupModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      @if (editGroupError()) {
        <div class="alert alert--danger">{{ editGroupError() }}</div>
  }

  <!-- Member Settings Modal -->
        <form (ngSubmit)="updateGroup()">
        <div class="form-group">
          <label for="editGroupName">Group Name *</label>
          <input
            type="text"
            id="editGroupName"
            class="form-control"
            [(ngModel)]="editGroupName"
            name="editGroupName"
            maxlength="100"
            autocomplete="off"
            [disabled]="editGroupLoading()"
          />
        </div>

        <div class="form-group">
          <label for="editGroupDescription">Description (optional)</label>
          <textarea
            id="editGroupDescription"
            class="form-control"
            [(ngModel)]="editGroupDescription"
            name="editGroupDescription"
            rows="3"
            maxlength="500"
            autocomplete="off"
            [disabled]="editGroupLoading()"
          ></textarea>
        </div>

        <div class="modal__actions">
          <button type="button" class="btn btn--outline" (click)="closeEditGroupModal()" [disabled]="editGroupLoading()">
            Cancel
          </button>
          <button type="submit" class="btn btn--primary" [disabled]="editGroupLoading()">
            @if (editGroupLoading()) { Saving... } @else { Save Changes }
          </button>
        </div>
      </form>
      </div>
    </div>
  }

  <!-- Group Settings Modal -->
  @if (showGroupSettingsModal()) {
    <app-group-settings-modal
      [group]="group()!"
      [defaultGroupImage]="defaultGroupImage"
      [groupSettingsError]="groupSettingsError()"
      [groupSettingsLoading]="groupSettingsLoading()"
      [groupImageError]="groupImageError()"
      [groupImageUploading]="groupImageUploading()"
      [groupImagePreview]="groupImagePreview"
      [editHistoryRetentionDays]="editHistoryRetentionDays"
      [deleteGroupLoading]="deleteGroupLoading()"
      [confirmModalLoading]="confirmModalLoading()"
      (close)="closeGroupSettingsModal()"
      (submit)="updateGroupSettings()"
      (groupImageSelected)="onGroupImageSelected($event)"
      (uploadGroupImage)="uploadGroupImage()"
      (editHistoryRetentionDaysChange)="editHistoryRetentionDays = $event"
      (requestDeleteGroup)="requestDeleteGroup()"
    />
  }

  @if (showSeasonSettingsModal()) {
    <app-group-season-settings-modal
      [seasonSettingsError]="seasonSettingsError()"
      [seasonSettingsLoading]="seasonSettingsLoading()"
      [endSeasonLoading]="seasonResetLoading()"
      [canEndSeason]="canResetSeason()"
      [endSeasonHint]="endSeasonHint()"
      [editSeasonName]="editSeasonName"
      [editSeasonStartAt]="editSeasonStartAt"
      [editSeasonEndsAt]="editSeasonEndsAt"
      [editSeasonPauseDays]="editSeasonPauseDays"
      [editNextSeasonName]="editNextSeasonName"
      [editNextSeasonStartsAt]="editNextSeasonStartsAt"
      [nextSeasonStartMin]="getNextSeasonStartMinDate()"
      [editNextSeasonEndsAt]="editNextSeasonEndsAt"
      [editNextSeasonIsSuccessive]="editNextSeasonIsSuccessive"
      [editNextSeasonInterval]="editNextSeasonInterval"
      [editNextSeasonIntermissionDays]="editNextSeasonIntermissionDays"
      [seasonIntervalOptions]="seasonIntervalOptions"
      [seasonStartLocked]="!!group()?.activeSeasonStartedAt"
      (close)="closeSeasonSettingsModal()"
      (submit)="updateSeasonSettings()"
      (editSeasonNameChange)="editSeasonName = $event"
      (editSeasonStartAtChange)="editSeasonStartAt = $event"
      (editSeasonEndsAtChange)="editSeasonEndsAt = $event"
      (editSeasonPauseDaysChange)="editSeasonPauseDays = $event"
      (editNextSeasonNameChange)="editNextSeasonName = $event"
      (editNextSeasonStartsAtChange)="editNextSeasonStartsAt = $event"
      (editNextSeasonEndsAtChange)="editNextSeasonEndsAt = $event"
      (nextSeasonSuccessiveChange)="onNextSeasonSuccessiveChange($event)"
      (editNextSeasonIntervalChange)="editNextSeasonInterval = $event"
      (editNextSeasonIntermissionDaysChange)="editNextSeasonIntermissionDays = $event"
      (requestEndSeason)="requestEndSeason()"
    />
  }

  @if (showInviteUserModal()) {
    <div class="modal-overlay">
      <div class="modal card" (click)="$event.stopPropagation()">
        <div class="modal__header">
          <h2>Invite User</h2>
          <button class="modal__close" (click)="closeInviteUserModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <h3 class="modal__section-title">Invite Existing User</h3>
        @if (inviteUserSearchError()) {
          <div class="alert alert--danger">{{ inviteUserSearchError() }}</div>
        }
        @if (inviteUserSearchInfo()) {
          <div class="alert alert--warning invite-user-search-feedback">{{ inviteUserSearchInfo() }}</div>
        }
        @if (inviteUserActionError()) {
          <div class="alert alert--danger">{{ inviteUserActionError() }}</div>
        }
        @if (inviteUserActionSuccess()) {
          <div class="alert alert--success">{{ inviteUserActionSuccess() }}</div>
        }

        <form class="form-group search-form" (ngSubmit)="searchInvitableUsers()">
          <input
            type="text"
            class="form-control"
            [(ngModel)]="inviteUserSearchQuery"
            name="inviteUserSearchQuery"
            placeholder="Search by in-app name"
            maxlength="100"
            autocomplete="off"
            [disabled]="inviteUserSearchLoading()"
          />
          <button type="submit" class="btn btn--primary" [disabled]="inviteUserSearchLoading()">
            @if (inviteUserSearchLoading()) { Searching... } @else { Search }
          </button>
        </form>

        @if (inviteUserSearchResults().length === 0 && inviteUserSearchQuery.trim() && !inviteUserSearchLoading() && !inviteUserSearchInfo()) {
          <p class="text-muted invite-user-search-feedback">No invitable users found.</p>
        } @else if (inviteUserSearchResults().length > 0) {
          <div class="application-list invite-user-search-feedback">
            @for (user of inviteUserSearchResults(); track user.id) {
              <div class="application-item">
                <div class="application-item__info">
                  <span class="invite-result__identity">
                    @if (user.avatarUrl) {
                      <img
                        class="invite-result__avatar"
                        [src]="user.avatarUrl"
                        [alt]="user.inAppName"
                      />
                    } @else {
                      <span class="invite-result__avatar invite-result__avatar--fallback" aria-hidden="true">
                        <i class="fas fa-user"></i>
                      </span>
                    }
                    <span class="application-item__name">{{ user.inAppName }}</span>
                  </span>
                </div>
                <button
                  type="button"
                  class="btn btn--secondary"
                  [disabled]="inviteUserActionLoading()"
                  (click)="sendUserInvite(user.id)"
                >
                  Invite
                </button>
              </div>
            }
          </div>
        }

        <h3 class="modal__section-title">Invite by Email</h3>
        @if (inviteEmailError()) {
          <div class="alert alert--danger">{{ inviteEmailError() }}</div>
        }
        @if (inviteEmailSuccess()) {
          <div class="alert alert--success">{{ inviteEmailSuccess() }}</div>
        }

        <form (ngSubmit)="sendEmailInvite()">
          <div class="form-group">
            <label for="inviteEmailAddress">Email</label>
            <input
              type="email"
              id="inviteEmailAddress"
              class="form-control"
              [(ngModel)]="inviteEmailAddress"
              name="inviteEmailAddress"
              placeholder="name@example.com"
              maxlength="191"
              autocomplete="email"
              [disabled]="inviteEmailLoading()"
            />
          </div>
          <div class="modal__actions">
            <button type="button" class="btn btn--outline" (click)="closeInviteUserModal()">
              Close
            </button>
            <button type="submit" class="btn btn--primary" [disabled]="inviteEmailLoading()">
              @if (inviteEmailLoading()) { Sending... } @else { Send Invite }
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Member Settings Modal -->
  @if (showMemberSettingsModal()) {
    <div class="modal-overlay">
      <div class="modal card" (click)="$event.stopPropagation()">
        <div class="modal__header">
          <h2>Member Settings</h2>
          <button class="modal__close" (click)="closeMemberSettingsModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <app-group-applications-panel
          [members]="group()!.members"
          [adminCount]="adminCount()"
          [currentUserId]="currentUserId()"
          [applications]="groupApplications()"
          [applicationsLoading]="applicationsLoading()"
          [applicationsError]="applicationsError()"
          [applicationActionLoading]="applicationActionLoading()"
          (promote)="promoteMemberById($event)"
          (demote)="demoteMemberById($event)"
          (remove)="removeMemberById($event)"
          (accept)="acceptApplication($event)"
          (reject)="rejectApplication($event)"
        />
      </div>
    </div>
  }

<!-- Confirmation Modal -->
@if (showConfirmModal()) {
  <div class="modal-overlay">
    <div class="modal modal--confirm card" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <h2>{{ confirmModalTitle }}</h2>
        <button class="modal__close" (click)="closeConfirmModal()" [disabled]="confirmModalLoading()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <p class="modal__message">{{ confirmModalMessage }}</p>
      <div class="modal__actions">
        <button class="btn btn--outline" (click)="closeConfirmModal()" [disabled]="confirmModalLoading()">
          Cancel
        </button>
        <button class="btn btn--danger btn--confirm-action" (click)="executeConfirmAction()" [disabled]="confirmModalLoading()">
          @if (confirmModalLoading()) {
            <i class="fas fa-spinner fa-spin"></i> Processing...
          } @else {
            Confirm
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Alert Modal -->
@if (showAlertModal()) {
  <div class="modal-overlay">
    <div class="modal modal--alert card">
      <div class="modal__header" [class.modal__header--error]="alertModalType === 'error'" [class.modal__header--success]="alertModalType === 'success'">
        <h2>
          @if (alertModalType === 'error') {
            <i class="fas fa-exclamation-circle"></i>
          } @else if (alertModalType === 'success') {
            <i class="fas fa-check-circle"></i>
          } @else {
            <i class="fas fa-info-circle"></i>
          }
          {{ alertModalTitle }}
        </h2>
        <button class="modal__close" (click)="closeAlertModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <p class="modal__message">{{ alertModalMessage }}</p>
      <div class="modal__actions">
        <button class="btn btn--primary" (click)="closeAlertModal()">
          OK
        </button>
      </div>
    </div>
  </div>
}
